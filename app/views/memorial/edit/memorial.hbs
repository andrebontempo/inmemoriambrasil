<main>
  <div class="custom-box p-3 my-3 mx-0">

    <!-- T√≠tulo -->
    <h3 class="mb-2">Editar Memorial</h3>

    <!-- Dados b√°sicos (fora do accordion) -->
    <div class="mb-4 text-muted">
      <strong>{{firstName}} {{lastName}}</strong><br>
      <small>inmemoriambrasil.com.br/{{slug}}</small>
    </div>

    <form action="/memorial/{{slug}}/memorial/update" method="POST">
      <input type="hidden" name="_method" value="PUT" />

      <div class="accordion" id="accordionMemorial">

        <!-- 2. Parentesco -->
        <div class="accordion-item">
          <h2 class="accordion-header">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
              data-bs-target="#parentesco">
              üë®‚Äçüë©‚Äçüëß Parentesco
            </button>
          </h2>

          <div id="parentesco" class="accordion-collapse collapse">
            <div class="accordion-body">
              <input type="text" class="form-control" name="kinship" value="{{kinship}}">
            </div>
          </div>
        </div>

        <!-- 3. Epit√°fio -->
        <div class="accordion-item">
          <h2 class="accordion-header">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
              data-bs-target="#epitafio">
              üïØÔ∏è Epit√°fio
            </button>
          </h2>

          <div id="epitafio" class="accordion-collapse collapse">
            <div class="accordion-body">
              <textarea class="form-control" name="epitaph" rows="3">{{epitaph}}</textarea>
            </div>
          </div>
        </div>

        <!-- 4. Datas e Locais -->
        <div class="accordion-item">
          <h2 class="accordion-header">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
              data-bs-target="#datasLocais">
              üìç Datas e Locais
            </button>
          </h2>

          <div id="datasLocais" class="accordion-collapse collapse">
            <div class="accordion-body">

              <h6 class="fw-bold mb-3">Nascimento</h6>
              <div class="row mb-4">
                <div class="col-md-4 mb-2">
                  <label class="form-label">Data</label>
                  <input type="date" class="form-control" name="birth[date]" value="{{birth.date}}">
                </div>
                <div class="col-md-4 mb-2">
                  <label class="form-label">Estado</label>
                  <select class="form-select" id="birthState" name="birth[state]" data-selected="{{birth.state}}">
                    <option value="">Selecione</option>
                  </select>
                </div>
                <div class="col-md-4 mb-2">
                  <label class="form-label">Cidade</label>
                  <select class="form-select" id="birthCity" name="birth[city]" data-selected="{{birth.city}}">
                    <option value="">Selecione</option>
                  </select>
                </div>
                <div class="col-md-4 mb-2">
                  <label class="form-label">Pa√≠s</label>
                  <input type="text" class="form-control" value="Brasil" disabled>
                </div>

              </div>

              <h6 class="fw-bold mb-3">Falecimento</h6>
              <div class="row">
                <div class="col-md-4 mb-2">
                  <label class="form-label">Data</label>
                  <input type="date" class="form-control" name="death[date]" value="{{death.date}}">
                </div>
                <div class="col-md-4 mb-2">
                  <label class="form-label">Estado</label>
                  <select class="form-select" id="deathState" name="death[state]" data-selected="{{death.state}}">
                    <option value="">Selecione</option>
                  </select>
                </div>
                <div class="col-md-4 mb-2">
                  <label class="form-label">Cidade</label>
                  <select class="form-select" id="deathCity" name="death[city]" data-selected="{{death.city}}">
                    <option value="">Selecione</option>
                  </select>
                </div>
                <div class="col-md-4 mb-2">
                  <label class="form-label">Pa√≠s</label>
                  <input type="text" class="form-control" value="Brasil" disabled>
                </div>

              </div>

            </div>
          </div>
        </div>

        <!-- 5. Mini Biografia -->
        <div class="accordion-item">
          <h2 class="accordion-header">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
              data-bs-target="#biografia">
              üìù Mini Biografia
            </button>
          </h2>

          <div id="biografia" class="accordion-collapse collapse">
            <div class="accordion-body">
              <textarea class="form-control" name="biography" rows="7">{{biography}}</textarea>
            </div>
          </div>
        </div>

        <!-- 6. Obitu√°rio -->
        <div class="accordion-item">
          <h2 class="accordion-header">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
              data-bs-target="#obituario">
              üïäÔ∏è Obitu√°rio
            </button>
          </h2>

          <div id="obituario" class="accordion-collapse collapse">
            <div class="accordion-body">
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label">Cemit√©rio</label>
                  <input type="text" class="form-control" name="obituary[cemetery]" value="{{obituary.cemetery}}">
                </div>

                <div class="col-md-6 mb-3">
                  <label class="form-label">Endere√ßo da Sepultura</label>
                  <input type="text" class="form-control" name="obituary[graveAddress]"
                    value="{{obituary.graveAddress}}">
                </div>

                <div class="col-md-6 mb-3">
                  <label class="form-label">Local do Vel√≥rio</label>
                  <input type="text" class="form-control" name="obituary[wakeLocation]"
                    value="{{obituary.wakeLocation}}">
                </div>

                <div class="col-md-6 mb-3">
                  <label class="form-label d-block">Vel√≥rio</label>
                  <div class="row g-2">
                    <div class="col-6">
                      <input type="date" class="form-control" name="obituary[wakeDate]"
                        value="{{formatDate obituary.wakeDate}}">
                    </div>
                    <div class="col-3">
                      <input type="time" class="form-control" name="obituary[wakeStart]" value="{{obituary.wakeStart}}">
                    </div>
                    <div class="col-3">
                      <input type="time" class="form-control" name="obituary[wakeEnd]" value="{{obituary.wakeEnd}}">
                    </div>
                  </div>
                </div>

                <div class="col-12 mb-3">
                  <label class="form-label">Mapa do Cemit√©rio</label>
                  <input type="url" class="form-control" name="obituary[cemeteryMap]" value="{{obituary.cemeteryMap}}">
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>

      <!-- Bot√µes -->
      <div class="d-flex justify-content-end gap-2 mt-4">
        <a href="/memorial/{{slug}}" class="btn-default-memorial">Cancelar</a>
        <button type="submit" class="btn-default-memorial">Atualizar</button>
      </div>

    </form>
  </div>
</main>
<script>
  async function loadStates(selectId, cityId) {
    const stateSelect = document.getElementById(selectId);
    const selectedState = stateSelect.dataset.selected;

    if (!stateSelect) return;

    const res = await fetch(
      "https://servicodados.ibge.gov.br/api/v1/localidades/estados?orderBy=nome"
    );
    const states = await res.json();

    states.forEach(state => {
      const option = document.createElement("option");
      option.value = state.sigla;
      option.textContent = `${state.nome} (${state.sigla})`;

      if (state.sigla === selectedState) {
        option.selected = true;
      }

      stateSelect.appendChild(option);
    });

    // Se j√° existe estado salvo, carrega cidades automaticamente
    if (stateSelect.value) {
      loadCities(selectId, cityId);
    }

    stateSelect.addEventListener("change", () => {
      loadCities(selectId, cityId);
    });
  }

  async function loadCities(stateId, cityId) {
    const stateSelect = document.getElementById(stateId);
    const citySelect = document.getElementById(cityId);
    const selectedCity = citySelect.dataset.selected;

    if (!stateSelect.value) {
      citySelect.innerHTML = `<option value="">Selecione a cidade</option>`;
      return;
    }

    citySelect.innerHTML = `<option value="">Carregando...</option>`;

    const res = await fetch(
      `https://servicodados.ibge.gov.br/api/v1/localidades/estados/${stateSelect.value}/municipios`
    );
    const cities = await res.json();

    citySelect.innerHTML = `<option value="">Selecione a cidade</option>`;

    cities.forEach(city => {
      const option = document.createElement("option");
      option.value = city.nome;
      option.textContent = city.nome;

      if (city.nome === selectedCity) {
        option.selected = true;
      }

      citySelect.appendChild(option);
    });
  }

  // Inicializa√ß√£o (nascimento e falecimento)
  document.addEventListener("DOMContentLoaded", () => {
    loadStates("birthState", "birthCity");
    loadStates("deathState", "deathCity");
  });
</script>