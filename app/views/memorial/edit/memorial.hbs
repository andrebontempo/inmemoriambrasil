<main>
  <!-- Formul√°rio de Edi√ß√£o do Memorial -->
  <div class="custom-box p-2 my-2 mx-0">
    <h3 class="mb-4">Editar Memorial</h3>

    <form action="/memorial/{{slug}}/memorial/update" method="POST">
      <input type="hidden" name="_method" value="PUT" />

      <!-- Cabe√ßalho do Memorial (dados fixos) -->
      <div class="mb-4 pb-3 border-bottom">

        <h3 class="fw-bold mb-1">
          üïäÔ∏è {{firstName}} {{lastName}}
        </h3>


        <div class="text-muted small">
          Link do memorial:<br>
          <a href="/memorial/{{slug}}" target="_blank" class="text-decoration-none">
            https://inmemoriambrasil.com.br/{{slug}}
          </a>
        </div>

      </div>


      <!-- ACCORDION -->
      <div class="accordion" id="accordionMemorial">

        <!-- 1. Parentesco -->
        <div class="accordion-item">
          <h2 class="accordion-header">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
              data-bs-target="#accParentesco" aria-expanded="false">
              Parentesco
            </button>
          </h2>

          <div id="accParentesco" class="accordion-collapse collapse">
            <div class="accordion-body">
              <input type="text" class="form-control" name="kinship" value="{{kinship}}">
            </div>
          </div>
        </div>


        <!-- 2. Epit√°fio -->
        <div class="accordion-item">
          <h2 class="accordion-header">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
              data-bs-target="#accEpitafio">
              Epit√°fio
            </button>
          </h2>
          <div id="accEpitafio" class="accordion-collapse collapse">
            <div class="accordion-body">
              <textarea class="form-control" name="epitaph" rows="3">{{epitaph}}</textarea>
            </div>
          </div>
        </div>

        <!-- 3. Datas e Locais -->
        <div class="accordion-item">
          <h2 class="accordion-header">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
              data-bs-target="#accDatas">
              Datas e Locais
            </button>
          </h2>
          <div id="accDatas" class="accordion-collapse collapse">
            <div class="accordion-body">

              <h6 class="fw-bold mb-3">üìç Nascimento</h6>
              <div class="row mb-4">
                <div class="col-md-4 mb-3">
                  <label class="form-label">Data</label>
                  <input type="date" class="form-control" name="birth[date]" value="{{birth.date}}">
                </div>
                <div class="col-md-4 mb-3">
                  <label class="form-label">Estado</label>
                  <select class="form-select" id="birthState" name="birth[state]" data-selected="{{birth.state}}">
                    <option value="">Selecione o estado</option>
                  </select>
                </div>
                <div class="col-md-4 mb-3">
                  <label class="form-label">Cidade</label>
                  <select class="form-select" id="birthCity" name="birth[city]" data-selected="{{birth.city}}">
                    <option value="">Selecione a cidade</option>
                  </select>
                </div>
              </div>

              <h6 class="fw-bold mb-3">üïäÔ∏è Falecimento</h6>
              <div class="row">
                <div class="col-md-4 mb-3">
                  <label class="form-label">Data</label>
                  <input type="date" class="form-control" name="death[date]" value="{{death.date}}">
                </div>
                <div class="col-md-4 mb-3">
                  <label class="form-label">Estado</label>
                  <select class="form-select" id="deathState" name="death[state]" data-selected="{{death.state}}">
                    <option value="">Selecione o estado</option>
                  </select>
                </div>
                <div class="col-md-4 mb-3">
                  <label class="form-label">Cidade</label>
                  <select class="form-select" id="deathCity" name="death[city]" data-selected="{{death.city}}">
                    <option value="">Selecione a cidade</option>
                  </select>
                </div>
              </div>

            </div>
          </div>
        </div>

        <!-- 4. Mini Biografia -->
        <div class="accordion-item">
          <h2 class="accordion-header">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#accBio">
              Mini Biografia
            </button>
          </h2>
          <div id="accBio" class="accordion-collapse collapse">
            <div class="accordion-body">
              <textarea class="form-control" name="biography" rows="7">{{biography}}</textarea>
            </div>
          </div>
        </div>

        <!-- 5. Obitu√°rio -->
        <div class="accordion-item">
          <h2 class="accordion-header">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
              data-bs-target="#accObito">
              Obitu√°rio
            </button>
          </h2>
          <div id="accObito" class="accordion-collapse collapse">
            <div class="accordion-body">
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label">Cemit√©rio</label>
                  <input type="text" class="form-control" name="obituary[cemetery]" value="{{obituary.cemetery}}">
                </div>

                <div class="col-md-6 mb-3">
                  <label class="form-label">Endere√ßo da Sepultura</label>
                  <input type="text" class="form-control" name="obituary[graveAddress]"
                    value="{{obituary.graveAddress}}">
                </div>

                <div class="col-md-5 mb-3">
                  <label class="form-label">Local do Vel√≥rio</label>
                  <input type="text" class="form-control" name="obituary[wakeLocation]"
                    value="{{obituary.wakeLocation}}">
                </div>

                <div class="col-md-3 mb-3">
                  <label class="form-label">Data</label>
                  <input type="date" class="form-control" name="obituary[wakeDate]"
                    value="{{formatDate obituary.wakeDate}}">
                </div>

                <div class="col-md-2 mb-3">
                  <label class="form-label">In√≠cio</label>
                  <input type="time" class="form-control" name="obituary[wakeStart]" value="{{obituary.wakeStart}}">
                </div>

                <div class="col-md-2 mb-3">
                  <label class="form-label">T√©rmino</label>
                  <input type="time" class="form-control" name="obituary[wakeEnd]" value="{{obituary.wakeEnd}}">
                </div>




                <div class="col-12 mb-3">
                  <label class="form-label">Mapa do Cemit√©rio</label>
                  <input type="url" class="form-control" name="obituary[cemeteryMap]" value="{{obituary.cemeteryMap}}">
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>

      <!-- Bot√µes -->
      <div class="d-flex justify-content-end gap-2 mt-4">
        <a href="/memorial/{{slug}}" class="btn-default-memorial">Cancelar</a>
        <button type="submit" class="btn-default-memorial">Atualizar</button>
      </div>

    </form>
  </div>
</main>

<!-- SCRIPT IBGE -->
<script>
  async function loadStates(stateSelectId, citySelectId) {
    const stateSelect = document.getElementById(stateSelectId);
    const citySelect = document.getElementById(citySelectId);
    if (!stateSelect || !citySelect) return;

    const selectedState = stateSelect.dataset.selected;
    const selectedCity = citySelect.dataset.selected;

    const res = await fetch(
      "https://servicodados.ibge.gov.br/api/v1/localidades/estados?orderBy=nome"
    );
    const states = await res.json();

    stateSelect.innerHTML = `<option value="">Selecione o estado</option>`;

    states.forEach(state => {
      const option = document.createElement("option");
      option.value = state.sigla;
      option.textContent = `${state.nome} (${state.sigla})`;
      if (state.sigla === selectedState) option.selected = true;
      stateSelect.appendChild(option);
    });

    if (stateSelect.value) {
      await loadCities(stateSelect.value, citySelect, selectedCity);
    }

    stateSelect.addEventListener("change", async () => {
      if (!stateSelect.value) {
        citySelect.innerHTML = `<option value="">Selecione a cidade</option>`;
        return;
      }
      await loadCities(stateSelect.value, citySelect, null);
    });
  }

  async function loadCities(uf, citySelect, selectedCity) {
    citySelect.innerHTML = `<option value="">Carregando cidades...</option>`;

    const res = await fetch(
      `https://servicodados.ibge.gov.br/api/v1/localidades/estados/${uf}/municipios`
    );
    const cities = await res.json();

    citySelect.innerHTML = `<option value="">Selecione a cidade</option>`;

    cities.forEach(city => {
      const option = document.createElement("option");
      option.value = city.nome;
      option.textContent = city.nome;
      if (city.nome === selectedCity) option.selected = true;
      citySelect.appendChild(option);
    });
  }

  document.addEventListener("DOMContentLoaded", () => {
    loadStates("birthState", "birthCity");
    loadStates("deathState", "deathCity");
  });
</script>